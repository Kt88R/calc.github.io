<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <style>
        * {
            font-family: 'Roboto', Arial, sans-serif;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        #calculator-container {
            width: 300px;
            height: 430px; /* Aumentada para acomodar la nueva fila */
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #display-area {
            background: #f7f7f7;
            padding: 4px 12px 1px 12px;
            border-bottom: 1px solid #e0e0e0;
            flex: 0 0 80px;
            display: flex;
            flex-direction: column;
        }

        #history {
            flex: 1;
            font-size: 12px;
            color: #666;
            text-align: right;
            overflow: auto;
            direction: ltr;
            padding-bottom: 1px;
            max-height: 50px;
        }

        #input-container {
            border-top: 1px solid #e0e0e0;
            padding-top: 1px;
            min-height: 25px;
        }

        #input {
            width: 100%;
            font-size: 20px;
            border: none;
            outline: none;
            background: transparent;
            text-align: right;
            color: #0633ee;
            resize: none;
            overflow: hidden;
            min-height: 25px;
            padding: 0;
            margin: 0;
            line-height: 1.2;
        }

        #buttons {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(6, 1fr); /* Ahora 6 filas en lugar de 5 */
            gap: 6px;
            padding: 10px;
            background: #fff;
        }

        .btn {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            background-color: #fff;
            border: 2px solid #1e90ff;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .btn:hover {
            background-color: #e6f2ff;
            transform: scale(1.03);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .operator {
            background-color: #eaf1ff;
        }

        .special {
            background-color: #f0f0f0;
        }

        .equal {
            background-color: #ffb224;
            color: #000;
            grid-column: span 2; /* Ocupa dos columnas */
        }

        .clear {
            background-color: #dfdfdf;
        }

        .copy-history {
            background-color: #e6f5ed;
        }

        .clear-history {
            background-color: #ffe6e6;
        }

        .scientific {
            background-color: #e6f0ff;
        }

        .tooltip {
            position: absolute;
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
        }

        .tooltip.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="calculator-container">
        <div id="display-area">
            <div id="history">
                <div id="containerForHistory"></div>
            </div>
            <div id="input-container">
                <textarea id="input" aria-label="calculator display" autocomplete="off" inputmode="none"></textarea>
            </div>
        </div>
        
        <div id="buttons">
            <!-- Nueva fila de botones -->
            <div class="btn special" id="symbolPercent">%</div>
            <div class="btn special" id="symbolPi">π</div>
            <div class="btn copy-history" id="symbolCopyHistory">CH</div>
            <div class="btn clear-history" id="symbolClearHistory">BH</div>
            <div class="btn scientific" id="symbolScientific">Cientif</div>
            
            <div class="btn operator" id="symbolPower">^</div>
            <div class="btn operator" id="symbolRoot">√</div>
            <div class="btn">7</div>
            <div class="btn">8</div>
            <div class="btn">9</div>
            
            <div class="btn operator" id="symbolDivision">÷</div>
            <div class="btn operator" id="symbolMultiply">×</div>
            <div class="btn">4</div>
            <div class="btn">5</div>
            <div class="btn">6</div>
            
            <div class="btn operator" id="symbolPlus">+</div>
            <div class="btn operator" id="symbolMinus">−</div>
            <div class="btn">1</div>
            <div class="btn">2</div>
            <div class="btn">3</div>
            
            <div class="btn special" id="symbolExclamation">!</div>
            <div class="btn special" id="symbolInverse">1/x</div>
            <div class="btn">,</div>
            <div class="btn">0</div>
            <div class="btn special" id="symbolBackspace">⌫</div>
            
            <div class="btn operator" id="symbolBracket1">(</div>
            <div class="btn operator" id="symbolBracket2">)</div>
            <div class="btn clear" id="symbolClear">C</div>
            <!-- El botón = ahora ocupa dos columnas -->
            <div class="btn equal" id="symbolEqual">=</div>
        </div>
    </div>

    <div id="tooltip" class="tooltip">Historial copiado</div>

    <script>
        // Configuración de math.js
        math.config({
            number: 'BigNumber',
            precision: 15,
        });

        // Variables globales
        let arrayOfRound_btn = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', ','];
        let history = '';

        // Elementos del DOM
        const input = document.getElementById('input');
        const containerForHistory = document.getElementById('containerForHistory');
        const buttons = document.getElementById('buttons');
        const tooltip = document.getElementById('tooltip');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            input.focus();
            increaseTextarea();
        });

        input.addEventListener('input', handlePressKeyboard);
        input.addEventListener('input', increaseTextarea);
        buttons.addEventListener('click', inputNumber);

        // Botones de operaciones
        document.getElementById("symbolPlus").addEventListener('click', () => addSymbol('+'));
        document.getElementById("symbolMinus").addEventListener('click', () => addSymbol('-'));
        document.getElementById("symbolMultiply").addEventListener('click', () => addSymbol('×'));
        document.getElementById("symbolDivision").addEventListener('click', () => addSymbol('÷'));
        document.getElementById("symbolBracket1").addEventListener('click', () => addSymbol('('));
        document.getElementById("symbolBracket2").addEventListener('click', () => addSymbol(')'));
        document.getElementById("symbolPower").addEventListener('click', () => addSymbol('^'));
        document.getElementById("symbolRoot").addEventListener('click', () => addSymbol('√'));
        document.getElementById("symbolInverse").addEventListener('click', calculateInverse);
        document.getElementById("symbolExclamation").addEventListener('click', () => addSymbol('!'));
        document.getElementById("symbolClear").addEventListener('click', Clear);
        document.getElementById("symbolBackspace").addEventListener('click', Backspace);
        document.getElementById("symbolEqual").addEventListener('click', Equal);
        
        // Nuevos botones
        document.getElementById("symbolPercent").addEventListener('click', () => addSymbol('%'));
        document.getElementById("symbolPi").addEventListener('click', () => addSymbol('π'));
        document.getElementById("symbolCopyHistory").addEventListener('click', copyHistory);
        document.getElementById("symbolClearHistory").addEventListener('click', clearHistory);
        document.getElementById("symbolScientific").addEventListener('click', openScientificCalculator);

        // Manejo del teclado
        input.addEventListener('keydown', (event) => {
            if (event.key === "Backspace") {
                event.preventDefault();
                Backspace();
            }
            if (event.key === "Enter") {
                event.preventDefault();
                Equal();
            }
        });

        // Funciones principales
        function handlePressKeyboard() {
            let cursorPosition = input.selectionStart;
            let strLength = input.value.length;
            let result = getFormatting(input.value);
            let newStrLength = result.length;
            input.value = result;

            let newCursorPosition = getNewCursorPosition(cursorPosition, strLength, newStrLength, result);
            input.setSelectionRange(newCursorPosition, newCursorPosition);
        }

        function inputNumber(event) {
            let value = event.target.textContent;
            if (arrayOfRound_btn.includes(value) && event.target.classList.contains('btn') === true) {
                addSymbol(value);
            }
        }

        function addSymbol(symbol) {
            let cursorPosition = input.selectionStart;
            let strLength = input.value.length;
            let firstPart = input.value.slice(0, cursorPosition);
            firstPart = firstPart + symbol;
            let rest = input.value.slice(cursorPosition);
            let result = firstPart + rest;
            result = getFormatting(result);
            let newStrLength = result.length;
            input.value = result;
            input.focus();
            let newCursorPosition = getNewCursorPosition(cursorPosition, strLength, newStrLength, result);
            input.setSelectionRange(newCursorPosition, newCursorPosition);
            increaseTextarea();
        }

        function Clear() {
            input.value = '';
            input.focus();
            input.dispatchEvent(new Event('input', {bubbles: true}));
        }

        function Backspace() {
            let cursorPosition = input.selectionStart;
            let strLength = input.value.length;
            let firstPart = input.value.slice(0, cursorPosition);
            let buffer = firstPart;
            let symbol = /[^\d\s]\s{0,}$/;
            firstPart = firstPart.replace(/.\s{0,}$/, '');
            let rest = input.value.slice(cursorPosition);
            let result = firstPart + rest;
            let ttt = symbol.test(buffer);
            if (ttt === false) {
                result = getFormattingForBackspace(result);
            }

            let newStrLength = result.length;
            input.value = result;
            input.focus();
            let newCursorPosition = getNewCursorPosition(cursorPosition - 1, strLength - 1, newStrLength, result);
            input.setSelectionRange(newCursorPosition, newCursorPosition);
            increaseTextarea();
        }

        function Equal() {
            let value = input.value.replace(/×/g, '*').replace(/÷/g, '/').replace(/\^/g, '^').replace(/,/g, ".").replace(/\s/g, "").replace(/√([\d\.]{1,}[⁰¹²³⁴⁵⁶⁷⁸⁹⁻]{0,})/g, "sqrt($1)").replace(/√\((.{1,})\)/g, "sqrt($1)").replace(/√(sqrt\(.{1,}\))/g, "sqrt($1)").replace(/π/g, "pi");
            if (value == '') {
                return;
            }
            try {
                let textFromInput = input.value;
                let result = math.evaluate(value);
                result = getFormatting(result);
                input.value = result;
                if (result) {
                    history = `${textFromInput} = ${result} <br> ${history}`;
                    containerForHistory.innerHTML = history;
                }
                containerForHistory.scrollTop = 0;
                input.focus();
                input.dispatchEvent(new Event('input', {bubbles: true}));
            } catch {
                input.value = "Error";
            }
        }

        function calculateInverse() {
            let currentValue = input.value.replace(/\s/g, '').replace(/,/g, '.');
            
            if (currentValue === '') {
                return;
            }
            
            try {
                // Si hay una expresión completa, evaluarla primero
                if (currentValue.includes('+') || currentValue.includes('-') || 
                    currentValue.includes('*') || currentValue.includes('/') ||
                    currentValue.includes('^') || currentValue.includes('√') ||
                    currentValue.includes('π')) {
                    
                    let evaluated = math.evaluate(currentValue.replace(/×/g, '*').replace(/÷/g, '/').replace(/π/g, 'pi'));
                    currentValue = evaluated.toString();
                }
                
                let numericValue = parseFloat(currentValue);
                
                if (numericValue === 0) {
                    input.value = "Error: División por cero";
                    return;
                }
                
                let inverse = 1 / numericValue;
                let result = getFormatting(inverse);
                
                // Actualizar el historial
                history = `1/(${input.value}) = ${result} <br> ${history}`;
                containerForHistory.innerHTML = history;
                
                input.value = result;
                input.focus();
                containerForHistory.scrollTop = 0;
            } catch {
                input.value = "Error";
            }
        }

        function copyHistory() {
            const historyText = containerForHistory.innerText.replace(/<br>/g, '\n');
            navigator.clipboard.writeText(historyText).then(() => {
                showTooltip("Historial copiado");
            }).catch(err => {
                console.error('Error al copiar el historial: ', err);
            });
        }

        function clearHistory() {
            history = '';
            containerForHistory.innerHTML = '';
            showTooltip("Historial borrado");
        }

        function openScientificCalculator() {
            // Abrir la calculadora científica en una nueva ventana
            window.open('https://web2.0calc.com/', '_blank');
            // Cerrar la ventana actual después de un breve retraso
            setTimeout(() => {
                window.close();
            }, 500);
        }

        function showTooltip(message) {
            tooltip.textContent = message;
            tooltip.classList.add('show');
            setTimeout(() => {
                tooltip.classList.remove('show');
            }, 2000);
        }

        function increaseTextarea() {
            input.style.height = 'auto';
            let newHeight = input.scrollHeight;
            input.style.height = Math.min(newHeight, 35) + "px";
        }

        function getNewCursorPosition(cursorPosition, strLength, newStrLength, beautyDigit) {
            let difference = strLength - cursorPosition;
            let newCursorPosition;
            
            switch (true) {
                case difference === 0:
                    newCursorPosition = newStrLength;
                    break;

                case newStrLength === strLength:
                    newCursorPosition = newStrLength - difference;
                    break;

                case newStrLength > strLength:
                    let array = beautyDigit.split('');
                    if (array[cursorPosition] === " ") {
                        difference = difference + 1;
                    }
                    newCursorPosition = newStrLength - difference;
                    break;

                case newStrLength < strLength:
                    newCursorPosition = newStrLength - difference;
                    if (newCursorPosition < 0) {
                        newCursorPosition = 0;
                    }
                    break;
            }
            return newCursorPosition;
        }

        function getFormatting(str) {
            if (typeof str === "number" || typeof str === "object") {
                str = str.toString();
            }

            if (str === undefined) {
                return;
            }
            str = str.replace(/[^0-9⁰¹²³⁴⁵⁶⁷⁸⁹⁻.,\!\+\-\*\/\(\)√÷×%e\^π]/g, '').replace(/\./g, ',').replace(/(\d)\(/g, '$1 × (').replace(/,{1,}/g, ',').replace(/\*/g, '×').replace(/\//g, '÷').replace(/\s{0,}([\+\-÷×])\s{0,}/g, " $1 ");
            let CommaIndex = str.indexOf(',');
            if (CommaIndex !== -1) {
                let array = [];
                let regexForRestV1 = /,\d{0,}/ig;
                let firstPart = str.slice(0, CommaIndex);
                let rest = str.slice(CommaIndex);
                let secondPart = regexForRestV1.exec(rest);
                rest = rest.slice(regexForRestV1.lastIndex);
                firstPart = firstPart.replace(/(\d)(\s{1,})(\d)/g, "$1$3").replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                array.push(firstPart);
                array.push(secondPart);
                CommaIndex = rest.indexOf(',', CommaIndex);

                while (CommaIndex !== -1) {
                    let regexForRestV2 = /,\d{0,}/ig;
                    firstPart = rest.slice(0, CommaIndex);
                    rest = rest.slice(CommaIndex);
                    secondPart = regexForRestV2.exec(rest);
                    rest = rest.slice(regexForRestV2.lastIndex);
                    firstPart = firstPart.replace(/(\d)(\s{1,})(\d)/g, "$1$3").replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                    array.push(firstPart);
                    array.push(secondPart);
                    CommaIndex = rest.indexOf(',', CommaIndex);
                }

                rest = rest.replace(/(\d)(\s{1,})(\d)/g, "$1$3").replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                array.push(rest);
                let sumOfArrayElements = '';
                for (let i = 0; i < array.length; i++) {
                    sumOfArrayElements += array[i];
                    str = sumOfArrayElements;
                }

            } else {
                str = str.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            }
            return str;
        }

        function getFormattingForBackspace(str) {
            if (typeof str === "number") {
                str = str.toString();
            }

            if (str === undefined) {
                return;
            }

            let CommaIndex = str.indexOf(',');
            if (CommaIndex !== -1) {
                let array = [];
                let regexForRestV1 = /,\d{0,}/ig;
                let firstPart = str.slice(0, CommaIndex);
                let rest = str.slice(CommaIndex);
                let secondPart = regexForRestV1.exec(rest);
                rest = rest.slice(regexForRestV1.lastIndex);
                firstPart = firstPart.replace(/(\d)(\s{1,})(\d)/g, "$1$3").replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                array.push(firstPart);
                array.push(secondPart);
                CommaIndex = rest.indexOf(',', CommaIndex);

                while (CommaIndex !== -1) {
                    let regexForRestV2 = /,\d{0,}/ig;
                    firstPart = rest.slice(0, CommaIndex);
                    rest = rest.slice(CommaIndex);
                    secondPart = regexForRestV2.exec(rest);
                    rest = rest.slice(regexForRestV2.lastIndex);
                    firstPart = firstPart.replace(/(\d)(\s{1,})(\d)/g, "$1$3").replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                    array.push(firstPart);
                    array.push(secondPart);
                    CommaIndex = rest.indexOf(',', CommaIndex);
                }

                rest = rest.replace(/(\d)(\s{1,})(\d)/g, "$1$3").replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                array.push(rest);
                let sumOfArrayElements = '';
                for (let i = 0; i < array.length; i++) {
                    sumOfArrayElements += array[i];
                    str = sumOfArrayElements;
                }

            } else {
                str = str.replace(/(\d)(\s{1,})(\d)/g, "$1$3").replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            }
            return str;
        }

        // Posicionar el tooltip cerca del botón CH
        document.getElementById('symbolCopyHistory').addEventListener('mouseover', function() {
            const rect = this.getBoundingClientRect();
            tooltip.style.top = (rect.top - 25) + 'px';
            tooltip.style.left = (rect.left + rect.width/2 - 40) + 'px';
        });
    </script>
</body>
</html>